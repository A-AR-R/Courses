<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0, width=device-width">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <meta name="author" content="Karen Reid">
  <meta name="description" content="Software Tools and Systems Programming">

  <title>CSC209 A2 Structs and Files - CSC209</title>

  <meta name="theme-color" content="#9c27b0">

  <link rel="stylesheet" href="/~csc209h/winter/static/css/main.css">
</head>


  <body>
    <a href="#content" tabindex="0" class="accessibility-aid">Skip to content</a>

<header class="header">
  <a class="header__logo" href="/~csc209h/winter" role="logo">
    <div class="header__logo__title">CSC209</div>
    <div class="header__logo__subtitle">Software Tools and Systems Programming</div>
  </a>

  <div class="header__nav">
    <a id="js-mobile-menu-trigger" class="header__nav__icon" href="#">
      <span class="header__nav__icon__text">Menu</span>

      <div class="header__nav__icon__lines" aria-hidden="true">
        <div class="header__nav__icon__lines__line"></div>
        <div class="header__nav__icon__lines__line"></div>
        <div class="header__nav__icon__lines__line"></div>
      </div>
    </a>

    <nav id="js-mobile-menu" class="header__nav__menu">
      
        
        
        
        
        <a class="header__nav__menu__item " href=/~csc209h/winter/announcements>Announcements</a>
        
      
        
        
        
        
        <a class="header__nav__menu__item " href=/~csc209h/winter/calendar>Calendar</a>
        
      
        
        
        
        
        <a class="header__nav__menu__item " href=/~csc209h/winter/syllabus>Syllabus</a>
        
      
        
        
        
        
        <a class="header__nav__menu__item " href=/~csc209h/winter/lectures>Lectures</a>
        
      
        
        
        
        
        <a class="header__nav__menu__item header__nav__menu__item--current" href=/~csc209h/winter/assignments>Assignments</a>
        
      
        
        
        
        
        <a class="header__nav__menu__item " href=/~csc209h/winter/grades>Grades</a>
        
      
        
        
        
        
          <a class="header__nav__menu__item " href=https://markus.teach.cs.toronto.edu/csc209-2017-01/>MarkUs</a>
        
      
        
        
        
        
          <a class="header__nav__menu__item " href=https://pcrs.teach.cs.toronto.edu/209/>PCRS-C</a>
        
      
        
        
        
        
        <a class="header__nav__menu__item " href=/~csc209h/winter/feedback>Anonymous Feedback</a>
        
      
        
        
        
        
          <a class="header__nav__menu__item " href=https://piazza.com/utoronto.ca/winter2017/csc209/home>Piazza</a>
        
      
    </nav>
  </div>
</header>


    <main id="content" class="page-content">
      <div class="post">
        <header class="post__header">
          <h1>CSC209 A2 Structs and Files</h1>
          <p class="post__header__meta">
            
            
          </p>
        </header>

        <article class="post__content">
          <h2 id="introduction">Introduction</h2>

<p>This term, we’re building the components of a simple file synchronization system. In the last assignment, you wrote code for computing the hash of input from standard input, so that we can identify when files have changed. In this assignment, you’ll write the code to perform a traversal over a file tree.</p>

<h3 id="background-files-and-directories">Background: Files and Directories</h3>

<p>We organize files and directories in a hierarchical structure that can be modelled by a tree. (We don’t need a full graph – i.e., a tree is sufficient – since a directory can only have one “parent” – one directory that contains it.) For this assignment, you’ll write code to traverse a file tree and to collect data about the files and directories that are encountered.</p>

<p>Let’s use the command line to explore a few directories. I’ll use <code class="highlighter-rouge">ls</code> to list the files in the solution directory for assignment 2:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>reid@wolf$ ls -lai
total 36
 5409959 drwxr-xr-x 3 reid instrs 4096 Feb  9 15:56 ./
 5409951 drwxr-xr-x 4 reid instrs 4096 Feb  9 15:55 ../
21483566 -rw-r--r-- 1 reid instrs  222 Feb  3 16:36 Makefile
21483560 -rw-r--r-- 2 reid instrs 3130 Feb  5 22:18 ftree.c
21483561 -rw-r--r-- 1 reid instrs 1000 Feb  3 16:15 ftree.h
21483562 -rw-r--r-- 1 reid instrs  114 Feb  3 16:15 hash.h
21483564 -rw-r--r-- 1 reid instrs  656 Feb  3 11:24 hash_functions.c
21483568 -rw-r--r-- 1 reid instrs  261 Feb  3 16:15 print_ftree.c
 5419389 drwxr-xr-x 2 reid instrs 4096 Feb  5 21:51 temp/
</code></pre>
</div>

<p><code class="highlighter-rouge">ls</code> shows us that the current directory contains nine entries.  Each file has a lot of information associated with it.  From left to right, <code class="highlighter-rouge">ls</code> shows us</p>

<ul>
  <li>the inode number (the OS’s unique identifier for a file),</li>
  <li>modes and permissions (what type of file it is and who can access it),</li>
  <li>the number of links to the file (the number of entries in directories which reference that file), who owns it (reid – me!),</li>
  <li>what group the file is in,</li>
  <li>the size of the file,</li>
  <li>the modification date, and</li>
  <li>the filename.</li>
</ul>

<p>The OS actually stores a few more pieces of data – like the last file access time – but the options I specified for <code class="highlighter-rouge">ls</code> didn’t request those pieces of information.</p>

<p>Much of this information won’t be too important to you for this assignment, but you <em>do</em> need to know if a file is a directory, a link, or a normal file. In this case, three of the entries are directories (they have a “d” at the front of the permissions, which is the second group of characters from the left, and a “/” is appended to their names on the far right of the output), and six are normal files. There are no links. However, the <code class="highlighter-rouge">temp</code> directory contains two different links:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>reid@wolf$ ls -lai
total 12
 5419389 drwxr-xr-x 2 reid instrs 4096 Feb  9 16:02 ./
 5409959 drwxr-xr-x 3 reid instrs 4096 Feb  9 15:56 ../
21483560 -rw-r--r-- 2 reid instrs 3130 Feb  5 22:18 ftree.c
20327677 -rw-r--r-- 1 reid instrs    0 Feb  5 21:51 hello.txt
20327678 lrwxrwxrwx 1 reid instrs    7 Feb  3 15:17 temp_link -&gt; ../temp/
</code></pre>
</div>

<p>This example shows what a link looks like. <code class="highlighter-rouge">temp_link</code> is an alias for <code class="highlighter-rouge">../temp</code> – for the directory we did an <code class="highlighter-rouge">ls</code> on! Does that break our ability to model file trees as trees? (Have we just found a cycle in our file tree?) Fortunately, no. The link isn’t a directory: links like these (<em>symbolic links</em>) are “aliases”. They are files that contain a <em>path</em> (a sequence of file names that specifies a location in a filesystem).</p>

<p>There’s actually another link in that picture. The inode (the first number on the right) for <code class="highlighter-rouge">ftree.c</code> in <code class="highlighter-rouge">temp</code> is the same as the inode for <code class="highlighter-rouge">ftree.c</code> in our first example. That means that both filenames refer to the <em>same data on disk</em>. This is more than a symbolic link: this is a <em>hard link</em>. Directories cannot have hard links: this preserves the requirement that each directory have exactly one parent.</p>

<p>Notice that every directory has two special directories: <code class="highlighter-rouge">.</code> and <code class="highlighter-rouge">..</code>. As you will recall from earlier in the term, <code class="highlighter-rouge">.</code> is the current directory and  <code class="highlighter-rouge">..</code> is the parent directory. These names allow us to navigate though the file system.</p>

<p>So, what have we seen? In the first example, I used <code class="highlighter-rouge">ls</code> on my current directory. That directory has a parent (we can see that it has a <code class="highlighter-rouge">..</code>), so it is not the <em>root</em> (the base) of the entire file structure on my disk. However, it is the <em>root of its own file tree</em>. It contains nine entries, two of which are itself and its parent directory. One of the entries it contains is a child directory, and when we look inside that directory, we found examples of links. So, <em>the file tree we examined in these examples has depth three</em>. The top level contains <code class="highlighter-rouge">.</code> (the directory itself) and nothing else. The next level includes the files accessible from <code class="highlighter-rouge">.</code>, excluding itself and its parent. (There are 7 nodes on the second level.) One of these nodes, <code class="highlighter-rouge">temp</code>, is a directory, and the third level of the tree includes the files in <code class="highlighter-rouge">temp</code>.</p>

<p>Try drawing the tree represented by our examples. Then, take a look at some of your own directories to make sure you understand the tree structure.</p>

<h3 id="accessing-file-information">Accessing File Information</h3>
<p>A <em>filesystem</em> is an operating system module that encapsulates the data structures used to track files on a disk and the functions used to manipulate those data structures. Fortunately for us, we don’t need to know much about those structures to use files. Instead, we simply need to understand the <em>system calls</em> that the operating system exposes for users to access the file system and the <em>macros</em> that C provides to make using those system calls easier. (If you’re curious about how filesystems are implemented, we’ll learn a great deal more about them in CSC369.)</p>

<p>The system call you’ll need for this assignment is <code class="highlighter-rouge">stat</code>, and you’ll call it using the <a href="https://linux.die.net/man/2/lstat">C library function <code class="highlighter-rouge">lstat</code></a>. (Take a moment to read the man page that was just linked. Keep it open as a reference while you code, too.) <code class="highlighter-rouge">lstat</code> fills in a <code class="highlighter-rouge">struct stat</code> with information about the file you ask about. Note that you’ll need to include several header files to get everything you need for <code class="highlighter-rouge">lstat</code>. (The man page lists <code class="highlighter-rouge">sys/types.h</code>, <code class="highlighter-rouge">sys/stat.h</code>, and <code class="highlighter-rouge">unistd.h</code>.)</p>

<p>The <code class="highlighter-rouge">st_mode</code> field of the <code class="highlighter-rouge">struct stat</code> is particularly interesting, since it can tell you whether a file is a directory or link. A series of macros (and constants) are provided (check the man page!) to help you extract data from the field: <code class="highlighter-rouge">S_ISREG</code>, <code class="highlighter-rouge">S_ISDIR</code>, and <code class="highlighter-rouge">S_ISLNK</code> will be useful in this assignment. It’s also useful to know that the <em>permissions</em> on the file can be extracted by applying a <em>bitwise and</em> to the <code class="highlighter-rouge">st_mode</code> field and the octal value <code class="highlighter-rouge">0777</code>.</p>

<p>In addition to extracting data about individual files, you’ll need to be able to get all of the files within a directory. <a href="https://linux.die.net/man/3/opendir">The <code class="highlighter-rouge">opendir</code></a> and <a href="https://linux.die.net/man/3/readdir">the <code class="highlighter-rouge">readdir</code></a> functions will let you iterate through the files in a directory.</p>

<h2 id="tasks">Tasks</h2>

<p>This is a tree assignment. You will need to write a function that constructs a tree (an <code class="highlighter-rouge">FTree</code>) representing a file tree rooted at the file specified by the user. You will also write a function to walk an <code class="highlighter-rouge">FTree</code> and to print some of the file information stored in it. For example, here is the output of our solution run on the example directory from the previous section:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>reid@wolf$ ../print_ftree .
===== . (755) =====
  hash.h (644)
  print_ftree.c (644)
  hash_functions.c (644)
  ftree.c (644)
  Makefile (644)
  ===== temp (755) =====
    temp_link (777)
    ftree.c (644)
    hello.txt (644)
  ftree.h (644)
reid@wolf$ 
</code></pre>
</div>

<p>Here is an example run on a single directory (that contains links):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>reid@wolf$ ../print_ftree temp
===== temp (755) =====
  temp_link (777)
  ftree.c (644)
  hello.txt (644)
reid@wolf$
</code></pre>
</div>

<p>Here is an example run on a normal file or link:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>reid@wolf$ ../print_ftree temp/ftree.c
temp/ftree.c (644)
reid@wolf$ 

</code></pre>
</div>

<p>And finally, here is an example run on a file that doesn’t exist:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>reid@wolf$ ../print_ftree nofile      
lstat: No such file or directory
reid@wolf$
</code></pre>
</div>

<p>To summarize: The root of the <code class="highlighter-rouge">FTree</code> being created is the file specified on the command line. The program recursively walks the file system from that starting point and creates a <code class="highlighter-rouge">FTree</code> the models the file system structure. Each node of the <code class="highlighter-rouge">FTree</code> is a <code class="highlighter-rouge">TreeNode</code> and represents a file (normal, directory, or link) encountered in the walk. Specific pieces of information about the file must be stored in each <code class="highlighter-rouge">TreeNode</code>:</p>

<ul>
  <li>The name of the file.</li>
  <li>The permissions on the file.</li>
  <li>If the file is a directory, the linked list of <code class="highlighter-rouge">TreeNode</code>s that represent the files in the directory. No filename (or directory name) that starts with a <code class="highlighter-rouge">.</code> should be included. The order of files in the list should be the same as the order used by <code class="highlighter-rouge">readdir</code>.</li>
  <li>For normal files and links, a 64 bit (8 byte) hash (computed using the hash algorithm from assignment 1 of the contents of the file.</li>
</ul>

<p>While the <code class="highlighter-rouge">FTree</code> must track all of the information, your program will not print all of it. The program must provide <em>exactly</em> the output specified (as described in the examples above). In particular:</p>

<ul>
  <li>Each directory should be identified using equals signs. (There are five in the front and five in the back.)</li>
  <li>The contents of a directory should be indented two spaces more than the parent directory.</li>
  <li>Every line should contain the name of the file/directory followed by the permissions (in parentheses, as three octal digits).</li>
</ul>

<h3 id="starter-code">Starter Code</h3>

<p>Most of the structure of the assignment has been provided in the starter files. Note that we have provided both header (.h) files, which declare the existence of functions and global variables, and source (.c) files, where functions and variables are actually defined. The only starter file you may <em>modify</em> is <code class="highlighter-rouge">ftree.c</code>. You will also need to <em>provide</em> a new source file named <code class="highlighter-rouge">hash_functions.c</code> that contains a <code class="highlighter-rouge">hash</code> function.</p>

<p>Note that the <code class="highlighter-rouge">hash</code> function in <code class="highlighter-rouge">hash_functions.c</code> has a different signature than the one that you wrote in assignment 1.  It takes a <code class="highlighter-rouge">FILE *</code> which is an open file to read from.  Instead of using <code class="highlighter-rouge">scanf</code> you should read one byte at a time from the file using <code class="highlighter-rouge">fread</code>.  The block size is predefined to be 8 bytes.</p>

<p>In addition to source and header files, the starter code also includes a <code class="highlighter-rouge">Makefile</code>. This file contains commands for building your program. To build the program, just run <code class="highlighter-rouge">make</code> on the command line. To erase all of the intermediate files and the executable, run <code class="highlighter-rouge">make clean</code>.</p>

<p>Note that the Makefile includes the flag <code class="highlighter-rouge">-std=gnu99</code>.  This is included because the <code class="highlighter-rouge">c99</code> version of the compiler did not like the definitions of <code class="highlighter-rouge">lstat</code>.</p>

<h3 id="tips">Tips</h3>

<p>man pages are the best source of information for the system and library calls you need. Start by reading them carefully. Then, construct short programs to try out the syscalls you need, to develop an understanding of how they work. For example, you may want to start by writing a program that calls <code class="highlighter-rouge">lstat</code> on a single file and prints all of the information that you need to store in a <code class="highlighter-rouge">TreeNode</code>. Later, you may want to write a program that checks if a file is a directory and, if it is, uses <code class="highlighter-rouge">opendir</code> and <code class="highlighter-rouge">readdir</code> to print the names of all the files in the directory. After you’ve constructed these test programs, try to incorporate what you’ve learned into the program you’re writing for this assignment.</p>

<p>While only two functions are required, you may wish to create additional recursive helper functions, and you’re welcome to do so. However, remember that none of the files except for <code class="highlighter-rouge">ftree.c</code> should be modified.  (That also means you cannot change the definition of the structs defined in <code class="highlighter-rouge">ftree.h</code>.)</p>

<p>Build up functionality one small piece at a time and commit to git often.</p>

<p>Check for errors on <em>every</em> system or library call that is not a print.</p>

<p>Be very careful to initialize pointers to NULL and to make sure that you copy any strings that you use.</p>

<p>You should be able to reuse your <code class="highlighter-rouge">hash</code> function from A1 after a few modifications. Similarly, you should be able to use this code in A3, so try to write quality code. It’s worth spending extra time making sure it is well designed, robust, and easy to read.</p>

<h3 id="submission-and-marking">Submission and Marking</h3>

<p>Your submission should be committed (and pushed) to your git repository by the due date. As before, we are using automated grading tools to provide functional feedback, so it’s important that your submission be in the correct location in your repository (under <code class="highlighter-rouge">a2/</code>), have the correct filenames (add <code class="highlighter-rouge">hash_functions.c</code> and don’t change other names!), be fully submitted (remember to add files, commit, <em>and</em> push!), compile without warnings or errors, and produce output in <em>exactly</em> the format requested.</p>

<p>Your program must compile on a teach.cs lab machine, so please test it there before submission. We will be using <code class="highlighter-rouge">gcc</code> to compile program with the flags <code class="highlighter-rouge">-Wall</code> and <code class="highlighter-rouge">-std=gnu99</code>, as demonstrated in the <code class="highlighter-rouge">Makefile</code>. Your program should not produce any error or warning messages when compiled. As in assignment 1, programs that do not compile will receive a 0. Programs that produce warning messages will be penalized.</p>


        </article>
      </div>
    </main>

    <footer class="footer">
  <div class="footer__top" aria-hidden="true">
    <button id="js-scroll-top">
      <svg xmlns="http://www.w3.org/2000/svg" width="10" height="6">
        <path d="M0 5l5-5"/>
        <path d="M5 0l5 5"/>
      </svg>
      Back to top
    </button>
  </div>

  <p class="footer__info">&copy; 2017 Karen Reid | Powered by <a href="https://jekyllrb.com/">Jekyll</a> on <a href="https://pages.github.com/">GitHub Pages</a></p>
</footer>

<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
<script src="/~csc209h/winter/static/js/script.js"></script>

  </body>
</html>
